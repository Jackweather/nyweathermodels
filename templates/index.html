<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>NY Fullscreen Viewer</title>
  <style>
    html,body{height:100%;margin:0;background:#000;color:#fff;font-family:Arial,Helvetica,sans-serif}
    .top-label{font-size:12px;color:#ddd;text-align:center;padding:8px 0}
    .top-left{position:fixed;left:12px;top:8px}
    .top-right{position:fixed;right:12px;top:8px}
    .img-wrap{height:calc(100vh - 92px);display:flex;align-items:center;justify-content:center}
    img{max-width:100%;max-height:100%;object-fit:contain}
    .controls{height:48px;display:flex;align-items:center;justify-content:center;padding:8px}
    .dropdown{position:relative}
    .dropdown button{padding:8px 12px;border-radius:6px;border:none;background:#fff;color:#000;cursor:pointer}
    .dropdown .dropdown-content{position:absolute;top:100%;left:0;background:#fff;color:#000;display:none;flex-direction:column;border-radius:4px;box-shadow:0 2px 6px rgba(0,0,0,0.3);overflow:hidden}
    .dropdown.active .dropdown-content{display:flex}
    .dropdown .dropdown-content button{background:none;border:none;padding:8px 12px;text-align:left;cursor:pointer}
    .close-btn{padding:8px 12px;border-radius:6px;border:none;background:#fff;color:#000;cursor:pointer}
  </style>
</head>
<body>
  <div class="top-left">
    <div class="dropdown" id="fs-dropdown">
      <button id="fs-vars-button">Variables</button>
      <div class="dropdown-content" id="fs-vars-list">
        <button data-view="mslp">MSLP</button>
        <button data-view="temp">2m-Temp</button>
        <button data-view="snow_8_to_1">Snow 8-to-1</button>
        <button data-view="snow_10_to_1">Snow 10-to-1</button>
        <button data-view="precip_type_rate">Precip Type Rate</button>
        <button data-view="wind">10m-Wind</button>
        <button data-view="total_precip">Total Precip</button>
      </div>
    </div>
  </div>
  <div class="top-right"><button class="close-btn" onclick="window.close()">Close</button></div>
  <div class="top-label">NY-Weather-Models.com</div>
  <div class="img-wrap">
    <img id="fswin-img" src="" alt="Fullscreen PNG">
  </div>
  <div class="controls">
    <input id="fswin-slider" type="range" min="0" max="0" value="0" step="1" style="width:80%">
  </div>

  <script>
    (function(){
      const img = document.getElementById('fswin-img');
      const slider = document.getElementById('fswin-slider');
      const fsDropdown = document.getElementById('fs-dropdown');
      const fsVarsButton = document.getElementById('fs-vars-button');
      const fsVarsList = document.getElementById('fs-vars-list');

      let files = [];
      let idx = 0;
      let isLoading = false; // true while preloading images
      let preloadMap = {}; // url -> Image object
      let preloadToken = null; // token used for cache-busting during a preload session
      let rafScheduled = false;
      let pendingIdx = null;

      // Try to load files from localStorage (set by opener)
      try{
        const stored = localStorage.getItem('fsFullscreenPngs');
        if (stored){ files = JSON.parse(stored); }
        const sidx = localStorage.getItem('fsStartIndex');
        if (sidx) idx = Number(sidx) || 0;
        // cleanup stored keys so they don't persist unnecessarily
        localStorage.removeItem('fsFullscreenPngs');
        localStorage.removeItem('fsStartIndex');
      }catch(e){ files = []; idx = 0 }

      function update(){
        if (files.length > 0){
          idx = Math.max(0, Math.min(files.length-1, idx));
          const file = files[idx];
          // prefer using the preloaded Image object's src so we reuse in-memory data
          if (preloadMap[file] && preloadMap[file].src){
            img.src = preloadMap[file].src;
          } else {
            img.src = file + (preloadToken ? ('?t=' + preloadToken) : '');
          }
          slider.max = Math.max(0, files.length-1);
          slider.value = idx;
          slider.disabled = isLoading || files.length === 0;
        } else {
          img.src = '';
          slider.max = 0;
          slider.value = 0;
          slider.disabled = true;
        }
      }

      // Throttle rapid slider input events with requestAnimationFrame and use preloaded images
      slider.addEventListener('input', ()=>{
        if (isLoading) return;
        pendingIdx = Number(slider.value);
        if (!rafScheduled){
          rafScheduled = true;
          requestAnimationFrame(()=>{
            rafScheduled = false;
            if (pendingIdx !== null){ idx = pendingIdx; pendingIdx = null; update(); }
          });
        }
      });

      document.addEventListener('keydown',(e)=>{
        if (isLoading) return;
        if (e.key === 'ArrowLeft'){ idx = Math.max(0, idx-1); update(); }
        if (e.key === 'ArrowRight'){ idx = Math.min(files.length-1, idx+1); update(); }
        if (e.key === 'Escape') window.close();
      });

      // Dropdown toggle
      fsVarsButton.addEventListener('click', (ev)=>{ ev.stopPropagation(); fsDropdown.classList.toggle('active'); });
      document.addEventListener('click', ()=> fsDropdown.classList.remove('active'));

      // Helper to preload image URLs, resolves when all attempted
      function preloadImages(urls){
        // clear previous preload map and set a session token so displayed src matches preloaded src
        preloadMap = {};
        preloadToken = Date.now();
        const token = preloadToken;
        return Promise.all(urls.map(u=>new Promise((resolve)=>{
          const im = new Image();
          im.onload = () => { preloadMap[u] = im; resolve({url:u,ok:true}); };
          im.onerror = () => { preloadMap[u] = im; resolve({url:u,ok:false}); };
          im.src = u + '?t=' + token;
        })));
      }

      // Wire variable buttons to fetch png list for fullscreen only
      fsVarsList.querySelectorAll('button').forEach(b=>{
        b.addEventListener('click', async (ev)=>{
          ev.stopPropagation();
          const view = b.getAttribute('data-view');
          // start loading lock
          isLoading = true;
          slider.disabled = true;
          try{
            const resp = await fetch(`/list_pngs/${view}`);
            if (resp.ok){
              const list = await resp.json() || [];
              // preload images before enabling navigation
              try{
                await preloadImages(list);
              }catch(_){ /* proceed even if some fail */ }
              files = list;
              idx = 0;
            }
          }catch(err){ console.error('Failed to fetch fullscreen list', err); }
          isLoading = false;
          update();
          fsDropdown.classList.remove('active');
        });
      });

      // If no files were provided via opener/localStorage, load precip type by default
      (async function loadDefaultIfEmpty(){
        if (!files || files.length === 0){
          isLoading = true;
          slider.disabled = true;
          try{
            const resp = await fetch('/list_pngs/precip_type_rate');
            if (resp.ok){
              const list = await resp.json() || [];
              try{ await preloadImages(list); }catch(_){ }
              files = list;
              idx = 0;
            }
          }catch(err){ console.error('Failed to fetch default precip list', err); }
          isLoading = false;
        }
        // initialize display regardless
        update();
      })();
    })();
  </script>
</body>
</html>
